### 基本介绍

工作流通过将复杂的任务分解成较小的步骤（节点）降低系统复杂度，减少了对提示词技术和模型推理能力的依赖，提高了 LLM 应用面向复杂任务的性能，提升了系统的可解释性、稳定性和容错性。

Dify 工作流分为两种类型：

* **Chatflow**：面向对话类情景，包括客户服务、语义搜索、以及其他需要在构建响应时进行多步逻辑的对话式应用程序。
* **Workflow**：面向自动化和批处理情景，适合高质量翻译、数据分析、内容生成、电子邮件自动化等应用程序。

为解决自然语言输入中用户意图识别的复杂性，Chatflow 提供了问题理解类节点。相对于 Workflow 增加了 Chatbot 特性的支持，如：对话历史（Memory）、标注回复、Answer 节点等。

为解决自动化和批处理情景中复杂业务逻辑，工作流提供了丰富的逻辑节点，如代码节点、IF/ELSE 节点、模板转换、迭代节点等，除此之外也将提供定时和事件触发的能力，方便构建自动化流程。

### 常见案例

- **客户服务:** 通过将 LLM 集成到你的客户服务系统中，你可以自动化回答常见问题，减轻支持团队的工作负担。 LLM 可以理解客户查询的上下文和意图，并实时生成有帮助且准确的回答。

- **内容生成：** 无论需要创建博客文章、产品描述还是营销材料，LLM 都可以通过生成高质量内容来帮助你。只需提供一个大纲或主题，LLM将利用其广泛的知识库来制作引人入胜、信息丰富且结构良好的内容。

- **任务自动化：** 可以与各种任务管理系统集成，如 Trello、Slack、Lark、以自动化项目和任务管理。通过使用自然语言处理，LLM 可以理解和解释用户输入，创建任务，更新状态和分配优先级，无需手动干预。

* **数据分析和报告：** 可以用于分析大型知识库并生成报告或摘要。通过提供相关信息给 LLM，它可以识别趋势、模式和洞察力，将原始数据转化为可操作的智能。对于希望做出数据驱动决策的企业来说，这尤其有价值。

* **邮件自动化处理：** LLM 可以用于起草电子邮件、社交媒体更新和其他形式的沟通。通过提供简要的大纲或关键要点，LLM 可以生成一个结构良好、连贯且与上下文相关的信息。这样可以节省大量时间，并确保你的回复清晰和专业。

### 如何开始

* 从一个空白的工作流开始构建或者使用系统模板帮助你开始；
* 熟悉基础操作，包括在画布上创建节点、连接和配置节点、调试工作流、查看运行历史等；
* 保存并发布一个工作流；
* 在已发布应用中运行或者通过 API 调用工作流；

# 搭建AI知识脑

## 1. 创建空白应用

输入应用名称为**AI知识脑-中国文化通史**，选择应用类型为**Chatflow**，点击创建。
<img src="/img/2.1.png" height=500>

## 2. 开始

**"开始"** 节点是每个工作流应用（Chatflow / Workflow）必备的预设节点，为后续工作流节点以及应用的正常流转提供必要的初始信息，例如应用使用者所输入的内容、以及上传的文件等。

### 配置节点

在开始节点的设置页，你可以看到两部分设置，分别是 **"输入字段"** 和预设的**系统变量**。

<img src="/img/2.2.png" height=500>

### 输入字段

输入字段功能由应用开发者设置，通常用于让应用使用者主动补全更多信息。例如在周报应用中要求使用者按照格式预先提供更多背景信息，如姓名、工作日期区间、工作详情等。这些前置信息将有助于 LLM 生成质量更高的答复。

支持以下六种类型输入变量，所有变量均可设置为必填项：

* **文本**：短文本，由应用使用者自行填写内容，最大长度 256 字符。
* **段落**：长文本，允许应用使用者输入较长字符。
* **下拉选项**：由应用开发者固定选项，应用使用者仅能选择预设选项，无法自行填写内容。
* **数字**：仅允许用户输入数字。
* **单文件**：允许应用使用者单独上传文件，支持文档类型文件、图片、音频、视频和其它文件类型。支持通过本地上传文件或粘贴文件 URL。
* **文件列表**：允许应用使用者批量上传文件，支持文档类型文件、图片、音频、视频和其它文件类型。支持通过本地上传文件或粘贴文件 URL。

配置完成后，用户在使用应用前将按照输入项指引，向 LLM 提供必要信息。更多的信息将有助于 LLM 提升问答效率。

<img src="/img/2.3.png" height=500>


### 系统变量

系统变量指的是在 Chatflow / Workflow 应用内预设的系统级参数，可以被应用内的其它节点全局读取。通常用于进阶开发场景，例如搭建多轮次对话应用、收集应用日志与监控、记录不同应用和用户的使用行为等。

**Chatflow**

Chatflow 类型应用提供以下系统变量：

| 变量名称                  | 数据类型         | 说明                                                                                        | 备注                                         |
| --------------------- | ------------ | ----------------------------------------------------------------------------------------- | ------------------------------------------ |
| `sys.query`           | String       | 用户在对话框中初始输入的内容                                                                            |                                            |
| `sys.files`           | Array\[File] | 用户在对话框内上传的文件                                                                              | 文件上传功能需在应用编排页右上角的 "功能" 处开启                 |
| `sys.dialogue_count`  | Number       | 用户在与 Chatflow 类型应用交互时的对话轮数。每轮对话后自动计数增加 1，可以和 if-else 节点搭配出丰富的分支逻辑。例如到第 X 轮对话时，回顾历史对话并给出分析 |                                            |
| `sys.conversation_id` | String       | 对话框交互会话的唯一标识符，将所有相关的消息分组到同一个对话中，确保 LLM 针对同一个主题和上下文持续对话                                    |                                            |
| `sys.user_id`         | String       | 分配给每个应用用户的唯一标识符，用以区分不同的对话用户                                                               |                                            |
| `sys.app_id`          | String       | 应用 ID，系统会向每个 Workflow 应用分配一个唯一的标识符，用以区分不同的应用，并通过此参数记录当前应用的基本信息                            | 面向具备开发能力的用户，通过此参数区分并定位不同的 Workflow 应用      |
| `sys.workflow_id`     | String       | Workflow ID，用于记录当前 Workflow 应用内所包含的所有节点信息                                                 | 面向具备开发能力的用户，可以通过此参数追踪并记录 Workflow 内的包含节点信息 |
| `sys.workflow_run_id` | String       | Workflow 应用运行 ID，用于记录 Workflow 应用中的运行情况                                                   | 面向具备开发能力的用户，可以通过此参数追踪应用的历次运行情况             |

<img src="/img/2.4.png" height=500>

## 3. 知识检索

**知识检索**是从知识库中检索与用户问题相关的文本内容，可作为下游 LLM 节点的上下文来使用。

<img src="/img/2.5.png" height=500>

### 配置流程

1. 选择查询变量。查询变量通常代表用户输入的问题，该变量可以作为输入项并检索知识库中的相关文本分段。在常见的对话类应用中一般将开始节点的 `sys.query` 作为查询变量，知识库所能接受的最大查询内容为 200 字符；
2. 选择需要查询的知识库，这里选择中国文化通史知识库；
3. 指定召回模式：当用户构建知识库问答类的 AI 应用时，如果在应用内关联了多个知识库，此时需要应用 Dify 的召回策略决定从哪些知识库中检索内容。
    **召回设置**
    根据用户意图同时匹配所有知识库，从多路知识库查询相关文本片段，经过重排序步骤，从多路查询结果中选择匹配用户问题的最佳结果，在多路召回模式下，检索器会在所有与应用关联的知识库中去检索与用户问题相关的文本内容，按照**权重设置**确定是优先语义还是优先关键字，根据Top K和Score阈值，将多路召回的相关文档结果合并.

    <img src="/img/2.6.png" height=500>

4. 连接并配置下游节点，一般为 LLM 节点；

<img src="/img/2.7.png" height=500>

**输出变量**

<img src="/img/2.8.png" height=500>

知识检索的输出变量 `result` 为从知识库中检索到的相关文本分段。其变量数据结构中包含了分段内容、标题、链接、图标等信息。

## 4. 配置下游LLM节点

LLM 节点是 Chatflow/Workflow 的核心节点。该节点能够利用大语言模型的对话/生成/分类/处理等能力，根据给定的提示词处理广泛的任务类型，并能够在工作流的不同环节使用。

* **意图识别**，在客服对话情景中，对用户问题进行意图识别和分类，导向下游不同的流程。
* **文本生成**，在文章生成情景中，作为内容生成的节点，根据主题、关键词生成符合的文本内容。
* **内容分类**，在邮件批处理情景中，对邮件的类型进行自动化分类，如咨询/投诉/垃圾邮件。
* **文本转换**，在文本翻译情景中，将用户提供的文本内容翻译成指定语言。
* **代码生成**，在辅助编程情景中，根据用户的要求生成指定的业务代码，编写测试用例。
* **RAG**，在知识库问答情景中，将检索到的相关知识和用户问题重新组织回复问题。
* **图片理解**，使用 vision 能力的多模态模型，能对图像内的信息进行理解和问答。

选择合适的模型，编写提示词，可以在 Chatflow/Workflow 中构建出强大、可靠的解决方案。

### 配置步骤
1. **选择模型**，Dify 提供了全球主流模型的支持，包括 OpenAI 的 GPT 系列、Anthropic 的 Claude 系列、Google 的 Gemini 系列等，选择一个模型取决于其推理能力、成本、响应速度、上下文窗口等因素，你需要根据场景需求和任务类型选择合适的模型。

> 初次使用 Dify ，在 LLM 节点选择模型之前，需要在 **系统设置—模型供应商** 内提前完成模型配置。

2. **配置模型参数**，模型参数用于控制模型的生成结果，例如温度、TopP，最大标记、回复格式等，为了方便选择系统同时提供了 3 套预设参数：创意，平衡和精确。如果对以上参数并不熟悉，建议选择默认设置。若希望应用具备图片分析能力，请选择具备视觉能力的模型。
3. **填写上下文（可选）**，上下文可以理解为向 LLM 提供的背景信息，常用于填写知识检索的输出变量。
4. **编写提示词**，LLM 节点提供了一个易用的提示词编排页面，选择聊天模型或补全模型，会显示不同的提示词编排结构。如果选择聊天模型（Chat model），可以自定义系统提示词（SYSTEM）/用户（USER）/ 助手（ASSISTANT）三部分内容。

    如果在编写系统提示词（SYSTEM）时没有好的思路，也可以使用提示生成器功能，借助 AI 能力快速生成适合实际业务场景的提示词。

    <img src="/img/2.9.png" height=500>

    在提示词编辑器中，你可以通过输入 **"/"** 呼出 **变量插入菜单**，将 **特殊变量块** 或者 **上游节点变量** 插入到提示词中作为上下文内容。

    <img src="/img/2.11.png" height=500>

5. **高级设置**，可以开关记忆功能并设置记忆窗口、开关 Vision 功能或者使用 Jinja-2 模板语言来进行更复杂的提示词等。


### 特殊变量说明

**上下文变量**

上下文变量是一种特殊变量类型，用于向 LLM 提供背景信息，常用于在知识检索场景下使用。

**模型参数**

模型的参数会影响模型的输出效果。不同模型的参数会有所区别。下图为`DeepSeek-V3`的参数列表。

<img src="/img/2.10.png" height=500>

主要的参数名词解释如下：

* **温度：** 通常是0-1的一个值，控制随机性。温度越接近0，结果越确定和重复，温度越接近1，结果越随机。
* **Top P：** 控制结果的多样性。模型根据概率从候选词中选择，确保累积概率不超过预设的阈值P。
* **存在惩罚：** 用于减少重复生成同一实体或信息，通过对已经生成的内容施加惩罚，使模型倾向于生成新的或不同的内容。参数值增加时，对于已经生成过的内容，模型在后续生成中被施加更大的惩罚，生成重复内容的可能性越低。
* **频率惩罚：** 对过于频繁出现的词或短语施加惩罚，通过降低这些词的生成概率。随着参数值的增加，对频繁出现的词或短语施加更大的惩罚。较高的参数值会减少这些词的出现频率，从而增加文本的词汇多样性。


### 高级功能

**记忆：** 开启记忆后问题分类器的每次输入将包含对话中的聊天历史，以帮助 LLM 理解上文，提高对话交互中的问题理解能力。

**记忆窗口：** 记忆窗口关闭时，系统会根据模型上下文窗口动态过滤聊天历史的传递数量；打开时用户可以精确控制聊天历史的传递数量（对数）。

**对话角色名设置：** 由于模型在训练阶段的差异，不同模型对于角色名的指令遵循程度不同，如 Human/Assistant，Human/AI，人类/助手等等。为适配多模型的提示响应效果，系统提供了对话角色名的设置，修改对话角色名将会修改会话历史的角色前缀。

**Jinja-2 模板：** LLM 的提示词编辑器内支持 Jinja-2 模板语言，允许你借助 Jinja2 这一强大的 Python 模板语言，实现轻量级数据转换和逻辑处理，参考[官方文档](https://jinja.palletsprojects.com/en/3.1.x/templates/)。

**错误重试**：针对节点发生的部分异常情况，通常情况下再次重试运行节点即可解决。开启错误重试功能后，节点将在发生错误的时候按照预设策略进行自动重试。你可以调整最大重试次数和每次重试间隔以设置重试策略。

* 最大重试次数为 10 次
* 最大重试间隔时间为 5000 ms

<img src="/img/2.12.png" height=500>

**异常处理**：提供多样化的节点错误处理策略，能够在当前节点发生错误时抛出故障信息而不中断主流程；或通过备用路径继续完成任务。

**结构化输出**：确保 LLM 返回的数据格式可用、稳定、可预测，减少错误处理和格式转换的工作。

### 为知识检索配置LLM
在常见的对话类应用中，知识库检索的下游节点一般为 LLM 节点，知识检索的**输出变量** `result` 需要配置在 LLM 节点中的 **上下文变量** 内关联赋值。关联后你可以在提示词的合适位置插入 **上下文变量**。

<img src="/img/2.10.png" height="500" />

>上下文变量是 LLM 节点内定义的特殊变量类型，用于在提示词内插入外部检索的文本内容。

**上下文变量示例：**

```markdown
# 角色
你是一个专业知识整理助手，擅长将各类复杂的知识进行系统梳理和清晰呈现，能够根据用户需求，对不同领域的知识进行有条理的整合与讲解。

## 技能
### 技能 1: 整理特定领域知识
1. 当用户提出整理某一领域的知识时，先确认该领域的具体范畴和重点方向。如果用户未明确，主动询问相关信息。
2. 运用工具搜索该领域的相关资料和信息。
3. 对搜索到的内容进行分析、归纳，以简洁明了且逻辑清晰的方式呈现给用户。
===回复示例===
   - **领域主题**：<具体领域名称>
   - **关键知识点 1**：<详细阐述知识点 1>
   - **关键知识点 2**：<详细阐述知识点 2>
   - ……
===示例结束===

### 技能 2: 知识关联讲解
1. 当用户希望了解某知识点与其他方面的关联时，使用工具搜索与之相关的知识体系和关联内容。
2. 对搜索到的信息进行整理和分析，为用户讲解该知识点在不同场景或领域中的联系与应用。
3. 通过实际案例或通俗易懂的比喻，帮助用户更好地理解这些关联。

### 技能 3: 解答知识疑问
1. 当用户提出关于某个知识领域的疑问时，运用工具搜索相关资料，寻找准确的答案。
2. 如果遇到模糊或不确定的内容，明确告知用户，并尽可能提供相关的参考信息或研究方向。
3. 以清晰、易懂的方式向用户解答疑问。

## 限制:
- 只讨论与知识整理{{#context#}}和讲解相关的内容，拒绝回答无关话题。
- 所输出的内容必须按照给定的格式进行组织，不能偏离框架要求。
- 回答应简洁明了，避免冗长复杂的表述。
- 通过工具获取所需信息，确保信息来源可靠。
- 请使用 Markdown 的 ^^ 形式说明引用来源。
```

当用户提问时，若在知识检索中召回了相关文本，文本内容会作为上下文变量中的值填入提示词，提供 LLM 回复问题；若未在知识库检索中召回相关的文本，上下文变量值为空，LLM 则会直接回复用户问题。

### 至此完成了初步的AI知识脑搭建

点击预览，体验知识库搭建后大模型的效果：

### 身份编排

**示例：** 

>作为中国文化通史专家，你需要根据用户提供的主题或问题，提供专业、全面且深入的文化历史分析


**输入：** 总结一下明代文化的特点

**输出：**
```markdown
### 明代文化的特点总结

#### 1. **佛教的革新与“人间佛教”的兴起**
   - **背景**：明代佛教失去政府保护，面临外部侵夺，传统教派（如天台、净土、禅宗）因循守旧，而太虚、欧阳渐等推动佛教现代化改革，倡导“人间佛教”，强调佛教与世俗社会的结合。^^《第二节 佛教的革新与佛教文化的活跃》^^

#### 2. **诗文衰落与市民文艺勃兴**
   - **诗文衰落**：明代初期短暂出现揭露社会黑暗的写实文学，但随后台阁体占据主流，内容空洞，追求形式雅正，缺乏创新。^^《第二节 正宗诗文的衰落与市民文艺的勃兴》^^
   - **市民文艺兴起**：随着商品经济发展，市民阶层壮大，戏曲、小说等通俗文学（如《金瓶梅》《三言二拍》）繁荣，反映市井生活与新兴市民价值观。

#### 3. **学术思想从虚浮空疏转向经世致用**
   - **理学僵化**：程朱理学被官方固化，脱离实际，士人空谈性理，忽视实用。^^《第四节 从虚浮空疏走向经世致用》^^
   - **实学兴起**：明中后期，王阳明心学强调“知行合一”，东林学派等倡导经世致用，关注社会现实问题。

#### 4. **社会风尚的巨变**
   - **前期**：明初朱元璋严刑峻法，社会崇尚节俭、恪守礼制，官场谨慎务实。^^《第四节 明前后期社会风尚的变化》^^
   - **后期**：正德后商品经济冲击，社会转向奢侈享乐，僭越礼制，官场贪腐成风，士人追求个性解放（如李贽“童心说”）。

#### 5. **官场与士人风尚的两极分化**
   - **明初**：高压统治下官员战战兢兢，政治效率较高。^^《三、明中后期的官场风尚与士人风尚》^^
   - **中后期**：吏治腐败，士人从谨小慎微转向或趋炎附势（如依附宦官），或批判现实（如东林党人）。

### 总结
明代文化呈现**新旧交替、矛盾交织**的特点：  
- **保守与革新并存**：传统佛教、诗文衰落，市民文化、心学兴起。  
- **压抑与解放冲突**：前期礼法严苛，后期奢靡放纵。  
- **虚浮向务实转型**：理学僵化后，经世思潮逐渐抬头。  

^^注：以上内容均整理自用户提供的明代文化章节文本。^^
```


可以看到，当用户提问时，知识检索召回到了相关文本，文本内容作为上下文变量中的值填入提示词，提供 LLM 回复问题；若未在知识库检索中召回相关的文本，上下文变量值为空，LLM 则会直接回复用户问题。

<img src="/img/2.13.png" height=500>


**输入：** 与明代不同的是，民国文化有哪些发展与变化？

**输出：**
```markdown
### 民国文化的发展与变化（对比明代）

---

#### **1. 文化论争：从"中西体用"到"本位与西化"**  
- **明代**：以儒学为核心，文化争论限于传统框架内（如理学vs心学）。  
- **民国**：  
  - **"中国本位文化"派**（如十教授宣言）主张以中国国情为基础吸收西方文化。  
  - **"全盘西化"派**（如胡适）主张彻底学习西方现代化模式。  
  - **背景**：五四运动后，西方科学民主思想冲击传统，争论更激烈且具国际视野。^^《第四节 “中国本位文化”与“全盘西化”之争》^^  

---

#### **2. 宗教世俗化：从神秘权威到社会参与**  
- **明代**：佛教受政府压制，改革限于教义内部（如人间佛教萌芽）。  
- **民国**：  
  - **佛教革新**：太虚大师推动"人生佛教"，强调教育、慈善等世俗实践。  
  - **其他宗教**：基督教、伊斯兰教等也通过办学校、医院融入社会。^^《第六章 走向世俗：民国的宗教世界》^^  

---

#### **3. 艺术大众化：从士大夫垄断到平民普及**  
- **明代**：市民文艺（小说、戏曲）兴起，但仍受士大夫审美影响。  
- **民国**：  
  - **新文化运动**：白话文推广使文学彻底大众化（如鲁迅小说）。  
  - **新兴艺术**：电影、话剧、摄影等西方艺术形式流行，反映现实生活。  

---

#### **4. 思想转型：从经世致用到多元思潮**  
- **明代**：实学仍属儒学范畴（如东林学派）。  
- **民国**：  
  - **西方思潮涌入**：自由主义、马克思主义、无政府主义等并存。  
  - **传统批判**：如熊十力"体用不二"论重构儒学，试图与科学民主调和。^^《（一）“体用不二”的本体论》^^  

---

### **总结：民国文化的突破性特征**  
1. **开放性**：主动接纳全球思潮，争论焦点从"如何维护传统"转向"如何现代化"。  
2. **平民性**：文化权力下移，艺术与教育服务对象扩展至普通民众。  
3. **实践性**：宗教、学术均强调社会改造功能，而非仅理论探讨。  

^^注：内容基于用户提供的民国文化章节及明代对比框架整理。^^
```

召回相关文本后，LLM 回答了用户的问题，给出了其内容的来源，贴合用户的预期。

<img src="/img/2.14.png" height=500>

点击发布，即可在探索中与 LLM 互动，体验知识脑搭建后大模型的效果。

<img src="/img/2.15.png" height=500>

<img src="/img/2.16.png" height=500>


