有些问题很复杂， 很难仅靠大规模语言模型的分析推理能力来解决。但是， 大规模语言模型仍然有足够的智慧来整体理解问题， 并利用其编码能力来解决这些问题。

在这种情况下， LangChain 提供了一种工具， 可为大规模语言模型赋予 "用 Python" 进行推理的能力， 也就是说， 大规模语言模型驱动的智能体将利用 Python 来解决复杂问题。这个工具就是 Python REPL， 它是一个简单的 Python shell， 可以执行 Python 命令。Python REPL 非常重要， 原因是它允许用户使用 Python 语法来执行复杂计算、生成代码并与语言模型进行交互。本节将举例说明该工具的功能。

---

## 利用Python REPL 工具创建智能体
首先， 使用 LangChain 中包含的 create_python_agent 类初始化智能体。为此， 需要为该类提供一个大规模语言模型和一个工具， 即本例中的 Python REPL:

```python
import os
from dotenv import load_dotenv
from langchain.agents.agent_types import AgentType
from langchain_community.chat_models import ChatOllama 
from langchain_experimental.agents.agent_toolkits.python.base import create_python_agent
from langchain_experimental.tools import PythonREPLTool

load_dotenv()

# 创建Ollama聊天模型实例 - 调用本地大模型
model = ChatOllama(
    model="deepseek-coder-v2:16b"，  # 代码生成的模型
    temperature=0，
    base_url="http://localhost:11434"  # Ollama默认本地端口
)

agent_executor = create_python_agent(
    llm=model，  # 使用Ollama模型
    tool=PythonREPLTool()，
    verbose=True，
    agent_type=AgentType.ZERO_SHOT_REACT_DESCRIPTION，
)

```
>这里模型选择为<a href="https://ollama.com/library/deepseek-coder-v2">deepseek-coder-v2:16b</a>， 一个开源的混合专家代码语言模型，在特定于代码的任务中实现与GPT4-Turbo相当的性能。详情可参考https://huggingface.co/deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct。

在开始使用智能体之前，先检查一下默认提示:
```python
print(agent_executor.agent.llm_chain.prompt.template)
```

如下所示即为输出结果。
```text
You are an agent designed to write and execute python code to answer questions.
You have access to a python REPL, which you can use to execute python code.
If you get an error, debug your code and try again.
Only use the output of your code to answer the question. 
You might know the answer without running any code, but you should still run the code to get the answer.
If it does not seem like you can write code to answer the question, just return "I don't know" as the answer.


Python_REPL - A Python shell. Use this to execute python commands. Input should be a valid python command. If you want to see the output of a value, you should print it out with `print(...)`.

Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [Python_REPL]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin!

Question: {input}
Thought:{agent_scratchpad}

```
> **注意：** 该提示词约束了智能体的行为， 使其仅使用 Python REPL 工具来回答问题。

---

## 一个简单的查询
现在，要求模型基于篮球运动员的样本属性生成散点图:
```python
query = """
In a different basketball game， we have the following player stats:
- Player A: 38 points， 10 rebounds， 7 assists
- Player B: 28 points， 9 rebounds， 6 assists
- Player C: 19 points， 6 rebounds， 3 assists
- Player D: 12 points， 4 rebounds， 2 assists
- Player E: 7 points， 2 rebounds， 1 assist

Could you create a scatter plot graph in Seaborn talk mode for each player, where the y-axis represents the number of points, the x-axis represents the number of rebounds, and use 'o' as the marker? Additionally, please label each point with the player's name and set the title as "Team Players."
"""

agent_executor.run(query)
```
### 输出结果如下:

- **推理链思考过程：**

```html
> Entering new AgentExecutor chain...
 To create a scatter plot graph in Seaborn talk mode for each player where the y-axis represents the number of points, the x-axis represents the number of rebounds, using 'o' as the marker, and labeling each point with the player's name, I need to follow these steps:

1. Create a DataFrame from the given player stats.
2. Use Seaborn to create scatter plots for each player.
3. Set the title of the plot to "Team Players."
4. Label each point with the player's name.

Action: Python_REPL

Action Input: 
    ```python
    import seaborn as sns
    import matplotlib.pyplot as plt
    import pandas as pd

    # Create a DataFrame from the given player stats
    data = {
        'Player': ['A', 'B', 'C', 'D', 'E'],
        'Points': [38, 28, 19, 12, 7],
        'Rebounds': [10, 9, 6, 4, 2],
        'Assists': [7, 6, 3, 2, 1]
    }
    df = pd.DataFrame(data)

    # Set the Seaborn theme to "talk" for better readability
    sns.set_context("talk")

    # Create a scatter plot for each player
    plt.figure(figsize=(10, 6))
    for i, row in df.iterrows():
        plt.scatter(row['Rebounds'], row['Points'], label=f'Player {row["Player"]}', marker='o')

    # Add labels and title
    plt.xlabel('Rebounds')
    plt.ylabel('Points')
    plt.title('Team Players')
    plt.legend()
    plt.show()

    ```
```

基于此输出结果附带有基于球员统计数据的图表，如下所示。
<p align="center">
<img src="/img/6.2.png" width="800"/>
</p>
<p align="center">
<b>python智能体生成的散点图</b>
</p>
---

## 房屋价格预测
下面来看另一个例子。假设想根据一些特征(如卧室数量或房屋大小)来预测房屋的价格。为此，可以要求智能体设计并训练一个模型，然后提供给定房屋的预测结果。例如，考虑下面的提示:

```python
query = """
I want to predict the price of a house given the following information: 
- the number of rooms 
- the number of bathrooms 
- the size of the house in square meters

Design and train a regression model to predict the price of a house. Generate and use synthetic data to train the model. 
Once the model is trained， tell me the price of a house with the following features: 
- 2 rooms 
- 1 bathroom 
- 100 square meters
"""

agent_executor.run(query)
```
在此，要求智能体在合成具有不同房间、浴室和面积配置的代表性房屋，每个房屋都有一个相关的价格作为因变量等数据之上训练一个回归模型，以给出具有上述特征的房屋的估计价格。

- **推理及结论:**
```html
> Entering new AgentExecutor chain...
To design and train a regression model for predicting the price of a house based on its number of rooms, number of bathrooms, and size in square meters, we can use Python with libraries such as scikit-learn to create a simple linear regression model. We will generate synthetic data to train this model.

Action:
Python_REPL

Action Input: 
    ```python
    import numpy as np
    import pandas as pd
    from sklearn.model_selection import train_test_split
    from sklearn.linear_model import LinearRegression
    from sklearn.metrics import mean_squared_error, r2_score

    # Generate synthetic data
    np.random.seed(42)
    num_samples = 100
    rooms = np.random.randint(1, 5, num_samples)
    bathrooms = np.random.randint(1, 3, num_samples)
    size = np.random.uniform(50, 200, num_samples)
    price = (rooms * 100 + bathrooms * 200 + size * 10).astype(int)

    # Create a DataFrame
    data = pd.DataFrame({'rooms': rooms, 'bathrooms': bathrooms, 'size': size, 'price': price})

    # Split the data into training and testing sets
    X = data[['rooms', 'bathrooms', 'size']]
    y = data['price']
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

    # Train the model
    model = LinearRegression()
    model.fit(X_train, y_train)

    # Predict on the test set
    y_pred = model.predict(X_test)

    # Evaluate the model
    mse = mean_squared_error(y_test, y_pred)
    r2 = r2_score(y_test, y_pred)
    print(f"Mean Squared Error: {mse}")
    print(f"R^2 Score: {r2}")

    # Predict the price of a house with 2 rooms, 1 bathroom, and 100 square meters
    house_features = np.array([[2, 1, 100]])
    predicted_price = model.predict(house_features)
    print(f"Predicted Price: {int(predicted_price[0])}")
    ```

Observation: Mean Squared Error: 0.08242819319667419
R^2 Score: 0.9999996814709232
Predicted Price: 1399

Thought:/root/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but LinearRegression was fitted with feature names
  warnings.warn(
The model has been trained successfully, and we can use it to predict the price of a house with given features. Let's proceed with the final step as per the instructions.

Final Answer: The predicted price of a house with 2 rooms, 1 bathroom, and 100 square meters is $1399.

> Finished chain.

```
如上所示，智能体能够生成合成训练数据，然后使用sklearn库训练一个合适的回归模型，并通过该模型预测所提供房屋的价格。

>通过使用这种方法，可以对智能体进行编程，使其在实时场景中充当算法工具。

---


## 智能建筑优化

假设要设计一个可解决智能建筑环境中优化问题的智能体。目标是优化楼宇中的供暖、通风和空调(Heating， Ventilation and Air Conditioning， HVAC)设定点，以最大限度地降低能源消耗成本，同时确保居住者的舒适度。先来定义一下问题对应的变量和约束条件:目标是在指定的舒适度范围内调整三个区域的温度设定点，同时考虑每个区域中每小时每度数具有不同的能源消耗成本。

目标是在能源效率和居住舒适度之间取得平衡。下面是对问题的描述，以及对其所包含的变量和约束条件(每个区域的能源消耗成本、每个区域的初始温度和每个区域的舒适度范围)进行初始化:
```python
query = """
Please strictly follow the steps below to solve the problem
1. Analyze the problem and plan solutions
2. Only enter 'Python_REPL' in Action:
3. Only enter the code in Action Input:
4. Execute only one code snippet at a time
5. Finally, return the result using Final Answer:


**Problem**:

You are tasked with optimizing the HVAC setpoints in a smart building to minimize energy costs while ensuring occupant comfort. The building has three zones, after the HVAC system is activated, all rooms will maintain a same temperature. The cost function for energy consumption is defined as:

- Zone 1: Energy cost = $0.05 per degree per hour
- Zone 2: Energy cost = $0.07 per degree per hour
- Zone 3: Energy cost = $0.06 per degree per hour

You need to find a optimal temperature for the three zones to minimize the energy cost while maintaining a comfortable temperature. The initial temperatures in each zone are as follows:

- Zone 1: 72°F
- Zone 2: 75°F
- Zone 3: 70°F

The comfort range for each zone is as follows:
- Zone 1: 70°F to 74°F
- Zone 2: 73°F to 77°F
- Zone 3: 68°F to 72°F

**Question**:

What is the minimum total energy cost (in dollars per hour) you can achieve by adjusting the temperature for the three zones within their respective comfort ranges?

"""

agent_executor.run(query)
```

然后，得到了以下完整推理链:
```html
> Entering new AgentExecutor chain...
 To solve this problem, we need to find a common temperature that minimizes the total energy cost while keeping each zone within its comfort range. We will evaluate temperatures within these ranges and calculate the total energy cost for each scenario. The goal is to find the temperature that results in the lowest possible total energy cost.

Action: Python_REPL

Action Input: 
    ```python
    # Define the energy costs per degree per hour for each zone
    cost_zone1 = 0.05
    cost_zone2 = 0.07
    cost_zone3 = 0.06

    # Define the comfort ranges for each zone
    comfort_range_zone1 = range(70, 75)
    comfort_range_zone2 = range(73, 78)
    comfort_range_zone3 = range(68, 73)

    # Initialize minimum total energy cost to a large number
    min_total_cost = float('inf')
    optimal_temperature = None

    # Iterate over possible temperatures within the comfort ranges
    for temp in range(max(comfort_range_zone1.start, comfort_range_zone2.start, comfort_range_zone3.start), 
                    min(comfort_range_zone1.stop, comfort_range_zone2.stop, comfort_range_zone3.stop) + 1):
        # Calculate the energy cost for each zone based on the temperature deviation from the target temperature
        cost_zone1 = abs(temp - 72) * cost_zone1
        cost_zone2 = abs(temp - 75) * cost_zone2
        cost_zone3 = abs(temp - 70) * cost_zone3
        
        # Calculate the total energy cost for all zones
        total_cost = cost_zone1 + cost_zone2 + cost_zone3
        
        # Update the minimum total energy cost and optimal temperature if a new minimum is found
        if total_cost < min_total_cost:
            min_total_cost = total_cost
            optimal_temperature = temp

    # Print the result
    print(f"The minimum total energy cost is ${min_total_cost:.2f} per hour with a common temperature of {optimal_temperature}°F.")
    ```

Observation: The minimum total energy cost is $0.37 per hour with a common temperature of 73°F.

Thought: I now know the final answer
Final Answer: The minimum total energy cost is $0.37 per hour with a common temperature of 73°F.

> Finished chain.
```



该智能体能够解决智能建筑优化问题，并在某些限制条件下找到最大化总能源消耗成本的方案。在考虑优化问题的范围内，这些模型还可以用类似的方法解决更多的用例，包括但不限于如下用例。
- **供应链优化：** 优化物流和货物配送，以最大限度地降低运输成本、减少库存并确保及时交货。
- **投资组合优化：** 在金融领域，利用算法构建投资组合，在管理风险的同时实现收益最大化。
- **路线规划：** 为送货卡车、紧急服务或共享出行平台规划最佳路线，以最大限度地减少旅行时间和燃料消耗。
- **生产流程优化：** 优化生产流程，以最大限度地减少浪费、能耗和生产成本，同时保证产品质量。
- **医疗资源分配：** 在大流行病或其他医疗危机期间，有效分配医院床位、医务人员和设备等医疗资源。
- **网络路由：** 优化计算机网络中的数据路由，以减少延迟、拥堵和能耗。
- **车队管理：** 优化出租车或送货车等车队的使用方式， 以降低运营成本， 提高服务质量。
- **库存管理：** 确定最佳库存水平和再订购点， 以最大限度地降低存储成本， 同时防止缺货。
- **农业规划：** 根据天气模式和市场需求优化作物播种和收获计划， 实现产量和利润最大化。
- **电信网络设计：** 设计电信网络布局， 在提供覆盖范围的同时最大限度地降低基础设施成本。
- **废物管理：** 优化垃圾收集车的行驶路线， 减少燃料消耗和排放。
- **航空公司机组人员调度：** 创建高效的机组人员日程安排， 使其既能遵守劳动法规， 又能最大限度地降低航空公司的成本。

Python REPL 智能体非常出色，但也有一些不足之处:

- **不支持 FileIO** 这意味着无法读写本地文件系统。

- **每次运行后，都会忘记变量** 这意味着它无法在模型响应后跟踪初始化变量。

>为了绕过这些注意事项, 9.5 节将介绍一个建立在 LangChain 智能体之上的开源项目: 代码解释器 API。